<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa - Join Group</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="language-switcher">
                <label data-i18n="language">Language</label>
                <select id="languageSelector" onchange="i18n.setLanguage(this.value)">
                    <option value="en" data-i18n="languageEN">English</option>
                    <option value="lt" data-i18n="languageLT">Lietuvi≈≥</option>
                </select>
            </div>
            <h1>üéÅ <span data-i18n="appTitle">Secret Santa</span></h1>
            <p class="subtitle" id="occasionName" data-i18n="loading">Loading...</p>
        </header>

        <main>
            <!-- Loading State -->
            <div id="loadingSection">
                <p data-i18n="loadingGroup">Loading group information...</p>
            </div>

            <!-- Error State -->
            <div id="errorSection" style="display: none;">
                <div class="error-box">
                    <h2 data-i18n="errorTitle">Oops!</h2>
                    <p id="errorMessage"></p>
                </div>
            </div>

            <!-- Join Form (for new participants) -->
            <div id="joinSection" style="display: none;">
                <div class="info-box">
                    <h3 id="groupOccasion"></h3>
                    <p id="groupMessage"></p>
                    <p id="groupBudget" class="budget"></p>
                </div>

                <form id="joinForm">
                    <div class="form-group">
                        <label for="participantSelect" data-i18n="whoAreYouLabel">Who are you? *</label>
                        <select id="participantSelect" required>
                            <option value="" data-i18n="whoAreYouPlaceholder">Select your name...</option>
                        </select>
                    </div>
                    <button type="submit" class="btn-primary" data-i18n="joinButton">Join Group</button>
                </form>
            </div>

            <!-- Participant Dashboard (for returning participants) -->
            <div id="dashboardSection" style="display: none;">
                <div class="info-box">
                    <h3 id="dashboardOccasion"></h3>
                    <p id="dashboardMessage"></p>
                    <p id="dashboardBudget" class="budget"></p>
                </div>

                <div class="assignment-box">
                    <h2 data-i18n="assignmentTitle">Your Secret Santa Assignment</h2>
                    <p data-i18n="assignmentIntro">You are Secret Santa for:</p>
                    <h3 class="assigned-name" id="assignedPerson"></h3>

                    <div id="theirPreferences">
                        <h4 data-i18n="theirPreferencesTitle">Their Gift Preferences:</h4>
                        <p id="theirPreferencesText" class="preferences-text"></p>
                    </div>
                </div>

                <div class="preferences-box">
                    <h3 data-i18n="yourPreferencesTitle">Your Gift Preferences</h3>
                    <p data-i18n="yourPreferencesIntro">Let your Secret Santa know what you'd like:</p>
                    <form id="preferencesForm">
                        <textarea id="giftPreferences" rows="4" data-i18n-placeholder="preferencesPlaceholder" placeholder="E.g., I love books, especially fantasy novels. I also enjoy coffee and board games..."></textarea>
                        <button type="submit" class="btn-primary" data-i18n="savePreferencesButton">Save Preferences</button>
                    </form>
                    <p class="hint" data-i18n="preferencesHelp">Your Secret Santa will see this message</p>
                </div>

                <div class="status-box">
                    <h4 data-i18n="groupStatusTitle">Group Status</h4>
                    <p id="participantStatus"></p>
                    <p id="expiresInfo"></p>
                </div>
            </div>
        </main>

        <footer>
            <p data-i18n="footerText">No registration required ‚Ä¢ No cookies ‚Ä¢ Temporary storage only</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/app.js"></script>
    <script>
        let currentGroup = null;
        let currentParticipant = null;

        async function loadGroup() {
            const urlParams = new URLSearchParams(window.location.search);
            const groupId = urlParams.get('id');

            if (!groupId) {
                showError(i18n.t('invalidLink'));
                return;
            }

            try {
                currentGroup = await getGroup(groupId);

                if (!currentGroup) {
                    showError(i18n.t('groupNotFound'));
                    return;
                }

                // Check if user already joined
                const sessionId = getSessionId();
                currentParticipant = await getParticipantBySession(groupId, sessionId);

                if (currentParticipant) {
                    await showDashboard();
                } else {
                    await showJoinForm();
                }
            } catch (error) {
                showError(i18n.t('errorLoadingGroup') + ' ' + error.message);
            }
        }

        async function showJoinForm() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('joinSection').style.display = 'block';

            document.getElementById('groupOccasion').textContent = currentGroup.occasion_name;
            document.getElementById('occasionName').textContent = currentGroup.occasion_name;
            document.getElementById('groupMessage').textContent = currentGroup.custom_message || '';

            if (currentGroup.budget_limit) {
                document.getElementById('groupBudget').textContent = i18n.t('budgetLabel') + ' ' + currentGroup.budget_limit;
            }

            // Get available participants (not yet joined)
            const joinedParticipants = await getGroupParticipants(currentGroup.id);
            const joinedNames = joinedParticipants.map(p => p.name);
            const availableNames = currentGroup.participants.filter(name => !joinedNames.includes(name));

            const select = document.getElementById('participantSelect');
            select.innerHTML = `<option value="">${i18n.t('whoAreYouPlaceholder')}</option>`;

            availableNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                select.appendChild(option);
            });

            if (availableNames.length === 0) {
                select.innerHTML = `<option value="">${i18n.t('allJoinedMessage')}</option>`;
                select.disabled = true;
                document.querySelector('#joinForm button').disabled = true;
            }
        }

        async function showDashboard() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';

            document.getElementById('dashboardOccasion').textContent = currentGroup.occasion_name;
            document.getElementById('occasionName').textContent = currentGroup.occasion_name;
            document.getElementById('dashboardMessage').textContent = currentGroup.custom_message || '';

            if (currentGroup.budget_limit) {
                document.getElementById('dashboardBudget').textContent = i18n.t('budgetLabel') + ' ' + currentGroup.budget_limit;
            }

            document.getElementById('assignedPerson').textContent = currentParticipant.assigned_to || i18n.t('loading');
            document.getElementById('giftPreferences').value = currentParticipant.gift_preferences || '';

            // Load their preferences (the person we're buying for)
            if (currentParticipant.assigned_to) {
                const theirInfo = await getParticipantByName(currentGroup.id, currentParticipant.assigned_to);
                const preferencesDiv = document.getElementById('theirPreferences');
                const preferencesText = document.getElementById('theirPreferencesText');

                if (theirInfo && theirInfo.gift_preferences) {
                    preferencesText.textContent = theirInfo.gift_preferences;
                } else {
                    preferencesText.textContent = i18n.t('noPreferences');
                    preferencesText.style.fontStyle = 'italic';
                    preferencesText.style.opacity = '0.7';
                }
            }

            // Show group status
            const allParticipants = await getGroupParticipants(currentGroup.id);
            const statusText = i18n.t('participantsJoined', { count: allParticipants.length, total: currentGroup.participants.length });
            document.getElementById('participantStatus').textContent = statusText;

            const expiresAt = new Date(currentGroup.expires_at);
            const now = new Date();
            const daysLeft = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
            document.getElementById('expiresInfo').textContent = i18n.t('expiresIn', { days: daysLeft });
        }

        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        document.getElementById('joinForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const selectedName = document.getElementById('participantSelect').value;
            if (!selectedName) {
                alert(i18n.t('selectName'));
                return;
            }

            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.textContent = i18n.t('joiningButton');

            try {
                const sessionId = getSessionId();
                currentParticipant = await joinGroup(currentGroup.id, selectedName, sessionId);
                await showDashboard();
            } catch (error) {
                alert(i18n.t('errorJoiningGroup') + ' ' + error.message);
                btn.disabled = false;
                btn.textContent = i18n.t('joinButton');
            }
        });

        document.getElementById('preferencesForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const preferences = document.getElementById('giftPreferences').value.trim();
            const btn = e.target.querySelector('button');
            btn.disabled = true;
            btn.textContent = i18n.t('savingButton');

            try {
                await updatePreferences(currentParticipant.id, preferences);
                btn.textContent = i18n.t('savedButton');
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = i18n.t('savePreferencesButton');
                }, 2000);
            } catch (error) {
                alert(i18n.t('errorSavingPreferences') + ' ' + error.message);
                btn.disabled = false;
                btn.textContent = i18n.t('savePreferencesButton');
            }
        });

        // Update dynamic content on language change
        document.addEventListener('languageChanged', () => {
            if (currentGroup && currentParticipant) {
                // Re-render the dashboard with new language
                if (document.getElementById('dashboardSection').style.display !== 'none') {
                    const allParticipants = getGroupParticipants(currentGroup.id).then(participants => {
                        const statusText = i18n.t('participantsJoined', { count: participants.length, total: currentGroup.participants.length });
                        document.getElementById('participantStatus').textContent = statusText;
                    });

                    const expiresAt = new Date(currentGroup.expires_at);
                    const now = new Date();
                    const daysLeft = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
                    document.getElementById('expiresInfo').textContent = i18n.t('expiresIn', { days: daysLeft });

                    if (currentGroup.budget_limit) {
                        document.getElementById('dashboardBudget').textContent = i18n.t('budgetLabel') + ' ' + currentGroup.budget_limit;
                    }
                }
            }
        });

        // Load group on page load
        loadGroup();
    </script>
</body>
</html>
