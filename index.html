<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa - Create Group</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="language-switcher">
                <label data-i18n="language">Language</label>
                <select id="languageSelector" onchange="i18n.setLanguage(this.value)">
                    <option value="en" data-i18n="languageEN">English</option>
                    <option value="lt" data-i18n="languageLT">Lietuvi≈≥</option>
                </select>
            </div>
            <h1>üéÅ <span data-i18n="appTitle">Secret Santa</span></h1>
            <p class="subtitle" data-i18n="subtitle">Create your Secret Santa group</p>
        </header>

        <main>
            <form id="createGroupForm">
                <div class="form-group">
                    <label for="occasionName" data-i18n="occasionLabel">Occasion Name *</label>
                    <input type="text" id="occasionName" data-i18n-placeholder="occasionPlaceholder" placeholder="e.g., Christmas 2025, Birthday Party" required>
                </div>

                <div class="form-group">
                    <label for="customMessage" data-i18n="customMessageLabel">Custom Message (Optional)</label>
                    <textarea id="customMessage" rows="3" data-i18n-placeholder="customMessagePlaceholder" placeholder="Add a special message for your group..."></textarea>
                </div>

                <div class="form-group">
                    <label for="budgetLimit" data-i18n="budgetLabel">Budget Limit (Optional)</label>
                    <input type="text" id="budgetLimit" data-i18n-placeholder="budgetPlaceholder" placeholder="e.g., $25, ‚Ç¨30, 1000 RSD">
                </div>

                <div class="form-group">
                    <label for="groupLifetime" data-i18n="groupLifetimeLabel">Group Active For (Days) *</label>
                    <input type="number" id="groupLifetime" value="30" min="1" max="365" required>
                </div>

                <div class="form-group">
                    <label data-i18n="participantsLabel">Participants *</label>
                    <div id="participantsList">
                        <div class="participant-item">
                            <input type="text" class="participant-name" placeholder="Participant name" required>
                            <button type="button" class="btn-remove" onclick="removeParticipant(this)" data-i18n="delete">Remove</button>
                        </div>
                        <div class="participant-item">
                            <input type="text" class="participant-name" placeholder="Participant name" required>
                            <button type="button" class="btn-remove" onclick="removeParticipant(this)" data-i18n="delete">Remove</button>
                        </div>
                        <div class="participant-item">
                            <input type="text" class="participant-name" placeholder="Participant name" required>
                            <button type="button" class="btn-remove" onclick="removeParticipant(this)" data-i18n="delete">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn-secondary" onclick="addParticipant()" id="addParticipantBtn">+ Add Participant</button>
                    <p class="hint" id="minParticipantsHint">Minimum 3 participants required</p>
                </div>

                <button type="submit" class="btn-primary" id="createBtn" data-i18n="createButton">Create Secret Santa Group</button>
            </form>

            <div id="resultSection" class="result-section" style="display: none;">
                <h2 data-i18n="successTitle">Group Created Successfully!</h2>
                <div class="link-box">
                    <label data-i18n="participantLink">Share this link with participants:</label>
                    <div class="link-container">
                        <input type="text" id="groupLink" readonly>
                        <button type="button" class="btn-copy" onclick="copyLink('groupLink')" data-i18n="copyLink">Copy</button>
                    </div>
                    <p class="hint" data-i18n="participantLinkHelp">Send this to all participants</p>
                </div>
                <div class="link-box">
                    <label data-i18n="adminLink">Admin link (for managing the group):</label>
                    <div class="link-container">
                        <input type="text" id="adminLink" readonly>
                        <button type="button" class="btn-copy" onclick="copyLink('adminLink')" data-i18n="copyLink">Copy</button>
                    </div>
                    <p class="hint" data-i18n="adminLinkHelp">Keep this private - it allows you to manage the group</p>
                </div>
                <button type="button" class="btn-secondary" onclick="location.reload()" id="createAnotherBtn">Create Another Group</button>
            </div>
        </main>

        <footer>
            <p data-i18n="footerText">No registration required ‚Ä¢ No cookies ‚Ä¢ Temporary storage only</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/app.js"></script>
    <script>
        function addParticipant() {
            const list = document.getElementById('participantsList');
            const div = document.createElement('div');
            div.className = 'participant-item';
            div.innerHTML = `
                <input type="text" class="participant-name" placeholder="Participant name" required>
                <button type="button" class="btn-remove" onclick="removeParticipant(this)" data-i18n="delete">Remove</button>
            `;
            list.appendChild(div);
            i18n.updatePage();
        }

        function removeParticipant(btn) {
            const items = document.querySelectorAll('.participant-item');
            if (items.length > 3) {
                btn.parentElement.remove();
            } else {
                alert(i18n.t('needTwoParticipants'));
            }
        }

        function copyLink(elementId) {
            const input = document.getElementById(elementId);
            input.select();
            input.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(input.value);

            const btn = input.nextElementSibling;
            const originalText = btn.textContent;
            btn.textContent = i18n.t('copiedSuccess');
            setTimeout(() => {
                i18n.updatePage();
            }, 2000);
        }

        document.getElementById('createGroupForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const occasionName = document.getElementById('occasionName').value.trim();
            const customMessage = document.getElementById('customMessage').value.trim();
            const budgetLimit = document.getElementById('budgetLimit').value.trim();
            const groupLifetime = parseInt(document.getElementById('groupLifetime').value);

            const participantInputs = document.querySelectorAll('.participant-name');
            const participants = Array.from(participantInputs)
                .map(input => input.value.trim())
                .filter(name => name.length > 0);

            if (participants.length < 3) {
                alert(i18n.t('needThreeParticipants'));
                return;
            }

            // Check for duplicate names
            const uniqueParticipants = [...new Set(participants)];
            if (uniqueParticipants.length !== participants.length) {
                alert(i18n.t('duplicateNames'));
                return;
            }

            const btn = document.getElementById('createBtn');
            btn.disabled = true;
            btn.textContent = i18n.t('creatingButton');

            try {
                const result = await createGroup({
                    occasionName,
                    customMessage,
                    budgetLimit,
                    participants: uniqueParticipants,
                    groupLifetime
                });

                const baseUrl = window.location.origin + window.location.pathname.replace('index.html', '');
                const groupLink = `${baseUrl}group.html?id=${result.id}`;
                const adminLink = `${baseUrl}admin.html?id=${result.id}&admin=${result.admin_code}`;

                document.getElementById('groupLink').value = groupLink;
                document.getElementById('adminLink').value = adminLink;
                document.getElementById('createGroupForm').style.display = 'none';
                document.getElementById('resultSection').style.display = 'block';
            } catch (error) {
                alert(i18n.t('errorCreatingGroup') + ' ' + error.message);
                btn.disabled = false;
                btn.textContent = i18n.t('createButton');
            }
        });

        // Update dynamic text on language change
        document.addEventListener('languageChanged', () => {
            const addBtn = document.getElementById('addParticipantBtn');
            if (addBtn) addBtn.textContent = '+ ' + i18n.t('participantsLabel');

            const hint = document.getElementById('minParticipantsHint');
            if (hint) hint.textContent = i18n.t('needThreeParticipants');

            const createAnotherBtn = document.getElementById('createAnotherBtn');
            if (createAnotherBtn) createAnotherBtn.textContent = i18n.t('createAnotherGroup');
        });
    </script>
</body>
</html>
