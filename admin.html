<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secret Santa - Admin Panel</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header>
            <div class="language-switcher">
                <label data-i18n="language">Language</label>
                <select id="languageSelector" onchange="i18n.setLanguage(this.value)">
                    <option value="en" data-i18n="languageEN">English</option>
                    <option value="lt" data-i18n="languageLT">Lietuvi≈≥</option>
                </select>
            </div>
            <h1>üéÅ <span data-i18n="appTitle">Secret Santa</span> - <span data-i18n="adminTitle">Admin Panel</span></h1>
            <p class="subtitle" id="occasionName" data-i18n="loading">Loading...</p>
        </header>

        <main>
            <!-- Loading State -->
            <div id="loadingSection">
                <p data-i18n="loadingAdmin">Loading admin panel...</p>
            </div>

            <!-- Error State -->
            <div id="errorSection" style="display: none;">
                <div class="error-box">
                    <h2 data-i18n="errorTitle">Access Denied</h2>
                    <p id="errorMessage"></p>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminSection" style="display: none;">
                <div class="info-box">
                    <h3 id="groupOccasion"></h3>
                    <p id="groupMessage"></p>
                    <p id="groupBudget" class="budget"></p>
                    <p id="expiresInfo"></p>
                </div>

                <div class="links-box">
                    <h3 data-i18n="participantLink">Share Links</h3>
                    <div class="link-container">
                        <label data-i18n="participantLink">Participant Link:</label>
                        <input type="text" id="groupLink" readonly>
                        <button type="button" class="btn-copy" onclick="copyLink('groupLink')" data-i18n="copyLink">Copy</button>
                    </div>
                </div>

                <div class="status-box">
                    <h3 data-i18n="groupStatusTitle">Group Status</h3>
                    <div id="participantList"></div>
                </div>

                <div class="admin-actions">
                    <h3 id="adminActionsTitle">Admin Actions</h3>
                    <button type="button" class="btn-warning" onclick="rerollAssignments()" data-i18n="rerollButton">Reroll All Assignments</button>
                    <p class="hint" id="rerollHint">This will randomly reassign everyone. Current assignments and preferences will be kept.</p>
                </div>

                <div class="assignments-box">
                    <h3 id="assignmentsBoxTitle">Current Assignments (View Only)</h3>
                    <p class="warning" id="assignmentsWarning">Secret Santa assignments are visible to you as admin. Don't share this with participants!</p>
                    <div id="assignmentsList"></div>
                </div>
            </div>
        </main>

        <footer>
            <p data-i18n="footerText">No registration required ‚Ä¢ No cookies ‚Ä¢ Temporary storage only</p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/config.js"></script>
    <script src="js/i18n.js"></script>
    <script src="js/app.js"></script>
    <script>
        let currentGroup = null;
        let participants = [];

        async function loadAdminPanel() {
            const urlParams = new URLSearchParams(window.location.search);
            const groupId = urlParams.get('id');
            const adminCode = urlParams.get('admin');

            if (!groupId || !adminCode) {
                showError(i18n.t('invalidLink'));
                return;
            }

            try {
                currentGroup = await getGroup(groupId);

                if (!currentGroup) {
                    showError(i18n.t('groupNotFound'));
                    return;
                }

                if (currentGroup.admin_code !== adminCode) {
                    showError(i18n.t('invalidAdminCode'));
                    return;
                }

                await showAdminDashboard();
            } catch (error) {
                showError(i18n.t('errorLoadingGroup') + ' ' + error.message);
            }
        }

        async function showAdminDashboard() {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('adminSection').style.display = 'block';

            document.getElementById('groupOccasion').textContent = currentGroup.occasion_name;
            document.getElementById('occasionName').textContent = currentGroup.occasion_name;
            document.getElementById('groupMessage').textContent = currentGroup.custom_message || '';

            if (currentGroup.budget_limit) {
                document.getElementById('groupBudget').textContent = i18n.t('budgetLabel') + ' ' + currentGroup.budget_limit;
            }

            const expiresAt = new Date(currentGroup.expires_at);
            const now = new Date();
            const daysLeft = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
            document.getElementById('expiresInfo').textContent = i18n.t('expiresIn', { days: daysLeft }) + ' (' + expiresAt.toLocaleDateString() + ')';

            // Set participant link
            const baseUrl = window.location.origin + window.location.pathname.replace('admin.html', '');
            const groupLink = `${baseUrl}group.html?id=${currentGroup.id}`;
            document.getElementById('groupLink').value = groupLink;

            // Update static text
            document.getElementById('adminActionsTitle').textContent = i18n.t('adminTitle');
            document.getElementById('rerollHint').textContent = i18n.t('rerollConfirm');
            document.getElementById('assignmentsBoxTitle').textContent = i18n.t('assignmentTitle');
            document.getElementById('assignmentsWarning').textContent = i18n.t('preferencesHelp');

            await refreshParticipantList();
        }

        async function refreshParticipantList() {
            participants = await getGroupParticipants(currentGroup.id);

            // Show participant status
            const participantListDiv = document.getElementById('participantList');
            const joinedNames = participants.map(p => p.name);
            const notJoinedNames = currentGroup.participants.filter(name => !joinedNames.includes(name));

            let html = `<p><strong>${i18n.t('participantsJoined', { count: participants.length, total: currentGroup.participants.length })}</strong></p>`;

            if (participants.length > 0) {
                html += `<h4>${i18n.t('joined')}:</h4><ul>`;
                participants.forEach(p => {
                    const prefIcon = p.gift_preferences ? '‚úì' : '‚óã';
                    html += `<li>${p.name} ${prefIcon} (${i18n.t('joined').toLowerCase()} ${new Date(p.joined_at).toLocaleDateString()})</li>`;
                });
                html += '</ul>';
                html += `<p class="hint">‚úì = ${i18n.t('hasPreferences')}, ‚óã = ${i18n.t('noPreferences')}</p>`;
            }

            if (notJoinedNames.length > 0) {
                html += `<h4>${i18n.t('notJoinedYet')}:</h4><ul>`;
                notJoinedNames.forEach(name => {
                    html += `<li>${name}</li>`;
                });
                html += '</ul>';
            }

            participantListDiv.innerHTML = html;

            // Show assignments
            const assignmentsDiv = document.getElementById('assignmentsList');
            if (participants.length > 0) {
                let assignmentsHtml = '<ul class="assignments-list">';
                participants.forEach(p => {
                    const assignedTo = p.assigned_to || i18n.t('notAssignedYet');
                    assignmentsHtml += `<li><strong>${p.name}</strong> ‚Üí ${assignedTo}</li>`;
                });
                assignmentsHtml += '</ul>';
                assignmentsDiv.innerHTML = assignmentsHtml;
            } else {
                assignmentsDiv.innerHTML = `<p>${i18n.t('noParticipantsYet')}</p>`;
            }
        }

        async function rerollAssignments() {
            if (!confirm(i18n.t('rerollConfirm'))) {
                return;
            }

            try {
                await rerollGroupAssignments(currentGroup.id);
                alert(i18n.t('rerollSuccess'));
                await refreshParticipantList();
            } catch (error) {
                alert(i18n.t('errorRerolling') + ' ' + error.message);
            }
        }

        function showError(message) {
            document.getElementById('loadingSection').style.display = 'none';
            document.getElementById('errorSection').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        function copyLink(elementId) {
            const input = document.getElementById(elementId);
            input.select();
            input.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(input.value);

            const btn = input.nextElementSibling;
            btn.textContent = i18n.t('copiedSuccess');
            setTimeout(() => {
                i18n.updatePage();
            }, 2000);
        }

        // Update dynamic content on language change
        document.addEventListener('languageChanged', () => {
            if (currentGroup) {
                // Refresh the display with new language
                const expiresAt = new Date(currentGroup.expires_at);
                const now = new Date();
                const daysLeft = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
                document.getElementById('expiresInfo').textContent = i18n.t('expiresIn', { days: daysLeft }) + ' (' + expiresAt.toLocaleDateString() + ')';

                if (currentGroup.budget_limit) {
                    document.getElementById('groupBudget').textContent = i18n.t('budgetLabel') + ' ' + currentGroup.budget_limit;
                }

                document.getElementById('adminActionsTitle').textContent = i18n.t('adminTitle');
                document.getElementById('rerollHint').textContent = i18n.t('rerollConfirm');
                document.getElementById('assignmentsBoxTitle').textContent = i18n.t('assignmentTitle');
                document.getElementById('assignmentsWarning').textContent = i18n.t('preferencesHelp');

                if (participants) {
                    refreshParticipantList();
                }
            }
        });

        // Load admin panel on page load
        loadAdminPanel();
    </script>
</body>
</html>
